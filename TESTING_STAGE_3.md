# Тестирование: Этап 3 (RLS и Storage policies)

## Что реализовано в этапе 3

Цель этапа: включить изоляцию пользовательских данных на уровне БД и Storage.

Реализовано:
- миграция RLS:
  - `supabase/migrations/20260223185118_stage3_rls.sql`
- миграция Storage policies:
  - `supabase/migrations/20260223185119_stage3_storage.sql`
- документация безопасности:
  - `docs/security.md`

## Подготовка к тестированию

1. Применить миграции этапа 2 и этапа 3 по порядку.
2. Иметь два тестовых аккаунта Supabase Auth:
- Пользователь A
- Пользователь B
3. Выполнять проверки через SQL Editor (с JWT контекстом пользователей) или через приложение/API под разными аккаунтами.

## Ручные тест-кейсы (этап 3)

### TC-01: RLS включён на всех доменных таблицах
Шаги:
1. Выполнить SQL из раздела `Smoke-проверки безопасности` в `docs/security.md`.

Ожидаемый результат:
- Для всех таблиц `relrowsecurity = true`.

### TC-02: Политики присутствуют для каждого CRUD
Шаги:
1. Выполнить SQL проверки политик из `docs/security.md`.

Ожидаемый результат:
- Для каждой таблицы есть политики `SELECT/INSERT/UPDATE/DELETE`.
- Для `storage.objects` есть политики `SELECT/INSERT/UPDATE/DELETE` с ограничением bucket/prefix.

### TC-03: Пользователь A не видит данные пользователя B
Шаги:
1. Под пользователем A создать запись в `training_plans`.
2. Под пользователем B выполнить `select` по таблице `training_plans`.

Ожидаемый результат:
- Пользователь B не получает записи пользователя A.

### TC-04: Пользователь B не может менять данные пользователя A
Шаги:
1. Под пользователем A создать тестовую запись.
2. Под пользователем B попытаться сделать `update` и `delete` этой записи.

Ожидаемый результат:
- Операции отклоняются политиками RLS.

### TC-05: Пользователь может создавать только свои строки (`user_id = auth.uid()`)
Шаги:
1. Под пользователем A выполнить `insert` в любую доменную таблицу:
- вариант 1: `user_id = auth.uid()`
- вариант 2: `user_id` другого пользователя

Ожидаемый результат:
- Вариант 1 проходит.
- Вариант 2 отклоняется policy `INSERT ... with check`.

### TC-06: Storage — доступ только к своему префиксу
Шаги:
1. Под пользователем A загрузить файл в `plan-files/{A_USER_ID}/...`.
2. Под пользователем B попытаться прочитать/обновить/удалить объект A.

Ожидаемый результат:
- Под пользователем B операции с объектом A отклоняются.

### TC-07: Storage — запрет записи вне своего префикса
Шаги:
1. Под пользователем A попытаться загрузить файл в путь `plan-files/{B_USER_ID}/...`.

Ожидаемый результат:
- Операция отклоняется policy `INSERT`.

## Что НЕ входит в этап 3 (ожидаемо)

- Импорт Excel и парсинг (этап 4).
- UI-экраны для workout/history.
- Интеграционные автотесты RLS (планируются на этап 8).
