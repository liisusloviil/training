# ADR-001: Risk Handling for `xlsx` Import Dependency

Дата: 23 февраля 2026  
Статус: Accepted

## Контекст

- MVP зависит от `xlsx` для парсинга входного Excel-файла плана.
- `npm audit --omit=dev --audit-level=high` показывает `high` advisory для `xlsx`.
- На текущий момент автоматического исправления (`npm audit fix`) нет.
- Полная замена библиотеки на этапе MVP увеличивает риск регрессий импорта и срыва релизного окна.

## Решение

Выбран вариант `B`: оставить `xlsx` на MVP, но зафиксировать **accepted risk** и добавить компенсирующие меры.

Компенсирующие меры в коде:

- ограничение размера файла (`5 MB`);
- ограничение числа листов, строк и колонок;
- ограничение общего числа упражнений в одном импорте;
- ограничение времени парсинга (`maxParseDurationMs`);
- повторная проверка лимита размера при чтении временного файла из Storage (defense-in-depth).

## Изменения реализации

- `lib/excel/validators.ts`
  - `IMPORT_GUARDRAILS`
  - `assertFileSizeLimit`
  - доп. валидации для week number
- `lib/excel/parser.ts`
  - guardrails по структуре workbook
  - ограничение времени парсинга и общего объёма данных
- `app/(app)/import/actions.ts`
  - проверка размера файла при `save` из temp Storage

## Последствия

Плюсы:

- снижен риск перегрузки парсера и DoS-подобных сценариев на уровне MVP;
- поведение импорта стало более предсказуемым и ограниченным.

Минусы:

- advisory по `xlsx` остаётся открытым как принятый риск;
- для post-MVP требуется переоценка и потенциальная миграция на альтернативный парсер.

## Release Policy

- Релиз допускается только при документированном accepted risk (этот ADR) и зелёных `test/lint/build`.
- Любые инциденты, связанные с импортом Excel, требуют пересмотра ADR и приоритизации миграции с `xlsx`.
