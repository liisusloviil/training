# Тестирование: Этап 4 (Импорт Excel и парсинг)

## Что реализовано в этапе 4

Цель этапа: загрузка `.xlsx`, серверный парсинг, валидация и транзакционное сохранение плана.

Реализовано:
- UI импорта с двумя шагами:
  - предпросмотр файла
  - подтверждение сохранения
- Server Action:
  - `app/(app)/import/actions.ts`
- Парсер Excel (SheetJS):
  - `lib/excel/parser.ts`
  - `lib/excel/validators.ts`
- Репозиторий сохранения в БД:
  - `lib/db/plan-repository.ts`
- RPC-функция атомарного импорта:
  - `supabase/migrations/20260223185725_stage4_import_function.sql`

## Подготовка к тестированию

1. Применить миграции этапов 2-4.
2. Убедиться, что bucket `plan-files` и policies этапа 3 применены.
3. Запустить приложение:

```bash
npm run dev
```

4. Войти под тестовым пользователем.

## Ручные тест-кейсы (этап 4)

### TC-01: Успешный предпросмотр корректного `.xlsx`
Шаги:
1. Открыть `/import`.
2. Загрузить корректный `.xlsx` файл по ожидаемому шаблону.
3. Нажать `Проверить файл`.

Ожидаемый результат:
- Появляется блок предпросмотра.
- Видны недели/дни/упражнения.
- Показаны агрегаты: количество недель, дней, упражнений.

### TC-02: Успешное подтверждение импорта
Шаги:
1. После предпросмотра нажать `Подтвердить и сохранить`.

Ожидаемый результат:
- Появляется сообщение об успешном сохранении.
- В БД создаётся новый активный план пользователя (`training_plans.is_active = true`).
- Создаются связанные записи в `plan_weeks`, `plan_days`, `plan_exercises`.

### TC-03: Некорректный формат файла (не `.xlsx`)
Шаги:
1. На `/import` выбрать файл с другим расширением (например `.csv`/`.txt`).
2. Нажать `Проверить файл`.

Ожидаемый результат:
- Импорт не выполняется.
- Показана понятная ошибка про поддерживаемый формат.

### TC-04: Некорректная структура (ошибки заголовков/данных)
Шаги:
1. Загрузить `.xlsx`, где отсутствует обязательная колонка (`упражнение` или `подходы×повторы`) или сломан формат `N×M`.
2. Нажать `Проверить файл`.

Ожидаемый результат:
- Импорт не выполняется.
- Пользователь получает понятную ошибку с причиной (и строкой/листом, если применимо).

### TC-05: Отсутствие частичных данных при ошибке сохранения
Шаги:
1. Смоделировать ошибку на этапе сохранения (например временно сломать RPC/ограничение в БД).
2. Подтвердить импорт.

Ожидаемый результат:
- Операция не завершается успешно.
- В БД нет частично созданного плана (атомарность RPC-функции).

### TC-06: Повторный импорт делает новый план активным
Шаги:
1. Импортировать план A.
2. Импортировать план B тем же пользователем.

Ожидаемый результат:
- У плана B `is_active = true`.
- У предыдущих активных планов пользователя `is_active = false`.

### TC-07: Проверка сохранения исходного файла в Storage
Шаги:
1. Выполнить успешный импорт.
2. Проверить запись `source_file_path` в `training_plans`.
3. Проверить наличие файла в bucket `plan-files` по этому пути.

Ожидаемый результат:
- Файл существует в Storage и доступен владельцу согласно policies.

## Что НЕ входит в этап 4 (ожидаемо)

- Отображение полного плана на `/plan` (детальная страница — этап 5).
- Создание workout-сессий и ввод сетов (этап 6).
- Экран истории тренировок (этап 7).

## Регрессия этапа 8 для импорта

В рамках этапа 8 добавлены обязательные регрессионные проверки импорта:

- автотесты:
  - `tests/integration/import-parser.test.ts`
- единый error contract server actions:
  - `lib/actions/contract.ts`
- критичное серверное логирование:
  - `lib/observability/server-logger.ts`

### TC-R01: Ошибка импорта возвращается в едином формате
Шаги:
1. На `/import` отправить некорректный файл.
2. Проверить ответ server action.

Ожидаемый результат:
- UI получает `status = "error"` и читаемый `message`.

### TC-R02: Критичные ошибки логируются
Шаги:
1. Смоделировать ошибку в server action импорта (например недоступность Storage/RPC).
2. Повторить `preview` или `save`.

Ожидаемый результат:
- в server logs появляется запись с `scope = import_plan_action`.

### TC-R03: Стабильность preview -> save после нескольких попыток
Шаги:
1. Сделать `preview` корректного файла.
2. Повторить `preview` другим файлом до `save`.
3. Подтвердить импорт.

Ожидаемый результат:
- не остаётся "битого" состояния формы;
- сохраняется последний подтверждённый вариант;
- предыдущий temp-файл корректно очищается.
