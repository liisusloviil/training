# Тестирование: Этап 6 (Сессия тренировки и ввод сетов)

## Что реализовано в этапе 6

Цель этапа: рабочий цикл тренировки от создания сессии до завершения.

Реализовано:
- Экран создания сессии:
  - `app/(app)/workout/new/page.tsx`
  - `components/workout/session-create-form.tsx`
- Экран выполнения тренировки:
  - `app/(app)/workout/[sessionId]/page.tsx`
  - `components/workout/session-header.tsx`
  - `components/workout/session-sets-form.tsx`
- Server Actions:
  - `app/(app)/workout/actions.ts`
- DB-слой:
  - `lib/db/session-repository.ts`
  - `lib/db/session-queries.ts`
- Типы:
  - `types/session.ts`

## Подготовка к тестированию

1. Применены миграции этапов 2-4 и stage-9 (`prescribed_reps_min/max`).
2. Есть импортированный активный план с днями и упражнениями.
3. Выполнен вход под тестовым пользователем.
4. Приложение запущено (`npm run dev`).

## Ручные тест-кейсы этапа 6

### TC-01: Создание новой сессии на валидную дату и день
Шаги:
1. Открыть `/workout/new`.
2. Выбрать день плана и дату.
3. Нажать `Создать сессию`.

Ожидаемый результат:
- Создаётся запись в `workout_sessions`.
- Происходит переход на `/workout/[sessionId]`.

### TC-02: Попытка создать дубликат сессии
Шаги:
1. Создать сессию на конкретную комбинацию `дата + день`.
2. Повторно создать сессию с той же комбинацией.

Ожидаемый результат:
- Новая запись не создаётся.
- Показана понятная ошибка о дубликате.
- Есть ссылка на уже существующую сессию.

### TC-03: UX формы сетов (fixed sets + reps per exercise)
Шаги:
1. Открыть `/workout/[sessionId]`.
2. Проверить, что для каждого упражнения число строк сетов фиксировано по плану.
3. Проверить отсутствие кнопки `Добавить сет`.
4. Проверить, что `set_number` не редактируется вручную.

Ожидаемый результат:
- Количество подходов берётся из `prescribed_sets` (fallback `1`).
- Кнопка добавления сетов отсутствует.
- `set_number` отображается как read-only значение.

### TC-04: Интерактивный выбор повторений
Шаги:
1. Для упражнения с диапазоном (например `4×8-12`) выбрать reps в выпадающем списке.
2. Проверить значения reps в строках сетов этого упражнения.
3. Для упражнения с фиксированными повторами проверить недоступный select с одним значением или статичное значение.

Ожидаемый результат:
- Для диапазона показывается `select` со значениями от `min` до `max` с шагом 1.
- Выбранный reps применяется ко всем сетам упражнения.
- Для фиксированного reps значение не изменяется пользователем.

### TC-05: Сохранение сетов и повторное чтение
Шаги:
1. Заполнить веса во всех сетах на экране.
2. Нажать `Сохранить сеты`.
3. Перезагрузить страницу.

Ожидаемый результат:
- Сеты сохраняются в `session_sets`.
- После reload значения reps/weights восстановлены из БД.
- Повторное сохранение выполняет upsert, не создаёт дубликаты по `(session_id, plan_exercise_id, set_number)`.

### TC-06: Ошибки валидации
Шаги:
1. Попробовать сохранить payload с `set_number > prescribed_sets` (через DevTools/запрос).
2. Попробовать сохранить payload с отрицательным `reps` или `weight`.

Ожидаемый результат:
- Сервер отклоняет некорректные данные с понятной ошибкой.
- Данные в БД не повреждаются.

### TC-07: Завершение сессии фиксирует completed_at
Шаги:
1. Иметь сохранённые сеты.
2. Нажать `Завершить тренировку`.

Ожидаемый результат:
- `workout_sessions.status = completed`.
- `completed_at` заполнен актуальным timestamp.

### TC-08: Попытка изменить completed-сессию
Шаги:
1. Открыть завершённую сессию.
2. Попробовать изменить данные сетов.

Ожидаемый результат:
- Экран в read-only режиме.
- Запись/завершение повторно не выполняются.

### TC-09: Попытка открыть/изменить чужую сессию
Шаги:
1. Под пользователем A создать сессию.
2. Под пользователем B перейти на `/workout/[sessionId_A]`.
3. Попробовать сохранить сеты или завершить.

Ожидаемый результат:
- Доступ к чужой сессии отсутствует.
- Изменение чужой сессии невозможно (RLS + фильтрация по user_id).

## Дополнение: последние доработки UX (24.02.2026)

Что изменено:
- Исправлен текстовый дефект лейбла повторов: теперь используется формат с гарантированным пробелом  
  `Повторы для упражнения <N>: <exerciseName>`.
- Выбор повторов для диапазона переведён со слайдера на `select` (дискретные значения `min..max`, шаг 1).
- Для фиксированных повторов используется статичное значение/неизменяемое состояние.
- Логика fixed-sets сохранена: ручного добавления подходов нет, `set_number` не редактируется.
- Серверный контракт и БД-схема не менялись.

Файлы доработки:
- `components/workout/session-sets-form.tsx`
- `app/globals.css`
- `tests/e2e/mvp-flow.spec.ts`
- `tests/integration/workout-actions.test.ts`
- `README.md`

### TC-10: Проверка лейбла повторов (фикс пробела)
Шаги:
1. Открыть `/workout/[sessionId]`.
2. Найти подпись блока выбора повторов.

Ожидаемый результат:
- Текст имеет вид `Повторы для упражнения 1: <название>`.
- Строка без пробела (`упражнения1`) нигде не встречается.

### TC-11: Проверка dropdown вместо range
Шаги:
1. Открыть упражнение с диапазоном `8-12`.
2. Проверить, что control повторов отображается как выпадающий список.
3. Проверить, что слайдер отсутствует.

Ожидаемый результат:
- На экране есть `select` для выбора reps.
- `input[type=range]` отсутствует.

### TC-12: Проверка опций диапазона в select
Шаги:
1. Для упражнения с диапазоном `8-12` открыть dropdown.
2. Проверить список значений.

Ожидаемый результат:
- Доступны ровно `8, 9, 10, 11, 12`.
- Значения целые и идут по возрастанию.

### TC-13: Проверка применения выбранных reps ко всем подходам
Шаги:
1. Выбрать в dropdown `11`.
2. Проверить все строки подходов этого упражнения.
3. Сохранить сеты, перезагрузить страницу.

Ожидаемый результат:
- Во всех подходах упражнения отображается `11`.
- После reload значение `11` и введённые веса восстановлены из БД.

### TC-14: Проверка fixed reps упражнения
Шаги:
1. Открыть упражнение с фиксированными повторами (без диапазона).

Ожидаемый результат:
- Повторы не редактируются пользователем.
- Поведение остаётся совместимым с сохранением и completed read-only режимом.

## Что НЕ входит в этап 6

- Полноценный экран истории `/history` (этап 7).
- Продвинутая аналитика и метрики прогресса.
- Offline/фоновое автосохранение.
